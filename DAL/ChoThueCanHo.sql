-- ======================================
-- SCRIPT TẠO CSDL QUẢN LÝ CĂN HỘ CHO THUÊ
-- ======================================

IF NOT EXISTS (
    SELECT name 
    FROM sys.databases 
    WHERE name = N'ChoThueCanHo'
)
BEGIN
    CREATE DATABASE ChoThueCanHo;
END
GO

USE ChoThueCanHo;
GO

-- 1. XÓA RÀNG BUỘC KHÓA NGOẠI VÀ CHỈ MỤC (NẾU CÓ)
IF OBJECT_ID('FK_HOA_DON_HOP_DONG') IS NOT NULL ALTER TABLE HOA_DON DROP CONSTRAINT FK_HOA_DON_HOP_DONG;
IF OBJECT_ID('FK_HOP_DONG_CAN_HO') IS NOT NULL ALTER TABLE HOP_DONG DROP CONSTRAINT FK_HOP_DONG_CAN_HO;
IF OBJECT_ID('FK_HOP_DONG_NGUOI_THUE_NHA') IS NOT NULL ALTER TABLE HOP_DONG DROP CONSTRAINT FK_HOP_DONG_NGUOI_THUE_NHA;
IF OBJECT_ID('FK_CAN_HO_CHU_NHA') IS NOT NULL ALTER TABLE CAN_HO DROP CONSTRAINT FK_CAN_HO_CHU_NHA;
IF OBJECT_ID('FK_TAI_KHOAN_CHU_NHA') IS NOT NULL ALTER TABLE TAI_KHOAN DROP CONSTRAINT FK_TAI_KHOAN_CHU_NHA;
GO

IF EXISTS (SELECT * FROM sys.indexes WHERE name = 'IDX_HOP_DONG_MA_CN') DROP INDEX IDX_HOP_DONG_MA_CN ON HOP_DONG;
IF EXISTS (SELECT * FROM sys.indexes WHERE name = 'IDX_HOA_DON_MA_HD') DROP INDEX IDX_HOA_DON_MA_HD ON HOA_DON;
GO

-- 2. XÓA BẢNG NẾU ĐÃ TỒN TẠI
DROP TABLE IF EXISTS HOA_DON;
DROP TABLE IF EXISTS HOP_DONG;
DROP TABLE IF EXISTS CAN_HO;
DROP TABLE IF EXISTS NGUOI_THUE_NHA;
DROP TABLE IF EXISTS TAI_KHOAN;
DROP TABLE IF EXISTS CHU_NHA;
GO

-- 3. TẠO BẢNG THEO THỨ TỰ PHỤ THUỘC
CREATE TABLE CHU_NHA (
    MA_CN VARCHAR(10) PRIMARY KEY,
    TEN_CN NVARCHAR(100),
    CCCD VARCHAR(12),       
    SDT VARCHAR(10),
    DIA_CHI NVARCHAR(255),
    EMAIL VARCHAR(50) UNIQUE,
    STK VARCHAR(20),
    NGAN_HANG NVARCHAR(50)
);

CREATE TABLE TAI_KHOAN (
    EMAIL VARCHAR(50) PRIMARY KEY,
    PASSWORDHASH VARCHAR(100),
    FOREIGN KEY (EMAIL) REFERENCES CHU_NHA(EMAIL)
);

CREATE TABLE NGUOI_THUE_NHA (
    MA_KH VARCHAR(10) PRIMARY KEY,
    TEN_KH NVARCHAR(100),
    SDT VARCHAR(10),
    CCCD_PASSPORT VARCHAR(12),
    QUOCTICH NVARCHAR(55),
    DIA_CHI NVARCHAR(255),
    EMAIL VARCHAR(50)
);

CREATE TABLE CAN_HO (
    MA_CH VARCHAR(10) PRIMARY KEY,
    MA_CN VARCHAR(10),
    TEN_CH NVARCHAR(255),
    DIA_CHI NVARCHAR(255),
    LOAI_CH NVARCHAR(50),
    DIEN_TICH DECIMAL(18, 2),
    GIA_THUE_DAI_HAN DECIMAL(18, 2),
    GIA_THUE_NGAN_HAN DECIMAL(18, 2),
    FOREIGN KEY (MA_CN) REFERENCES CHU_NHA(MA_CN)
);

CREATE TABLE HOP_DONG (
    MA_HD VARCHAR(10) PRIMARY KEY,
    MA_CH VARCHAR(10),
    MA_KH VARCHAR(10),
    NGAY_BAT_DAU DATE,
    NGAY_KET_THUC DATE,
    TIEN_COC DECIMAL(18, 2),
    FOREIGN KEY (MA_CH) REFERENCES CAN_HO(MA_CH),
    FOREIGN KEY (MA_KH) REFERENCES NGUOI_THUE_NHA(MA_KH)
);

CREATE TABLE HOA_DON (
    MA_HDONG VARCHAR(10) PRIMARY KEY,
    MA_HD VARCHAR(10),
    NGAY_LAP DATE,
    TONG_TIEN DECIMAL(18, 2),
    FOREIGN KEY (MA_HD) REFERENCES HOP_DONG(MA_HD)
);

-- 4. TẠO INDEX
CREATE INDEX IDX_HOP_DONG_MA_CN ON HOP_DONG(MA_KH);
CREATE INDEX IDX_HOA_DON_MA_HD ON HOA_DON(MA_HD);

-- 5. NHẬP DỮ LIỆU MẪU
-- CHỦ NHÀ
INSERT INTO CHU_NHA (MA_CN, TEN_CN, CCCD, SDT, DIA_CHI, EMAIL, STK, NGAN_HANG)
VALUES
('CN001', N'Nguyễn Văn A', '079805361544', '0912345678', N'123 Đường A, Q1, TP.HCM', 'nguyenvana@gmail.com', '0912345678', 'SACOMBANK'),
('CN002', N'Lê Thị B', '086515007896', '0987654321', N'456 Đường B, Q2, TP.HCM', 'lethib@gmail.com', '0987654321', 'VIETCOMBANK'),
('CN003', N'Trần Văn C', '079298061478', '0909090909', N'789 Đường C, Q3, TP.HCM', 'tranvanc@gmail.com', '0909090909', 'MBBANK');

-- TÀI KHOẢN
INSERT INTO TAI_KHOAN VALUES
('nguyenvana@gmail.com', 'a665a45920422f9d417e4867efdc4fb8a04a1f3fff1fa07e998e86f7f7a27ae3'); --pass:123

-- NGƯỜI THUÊ NHÀ
INSERT INTO NGUOI_THUE_NHA VALUES
('KH001', N'Phạm Thị D', '0911222333', '012345678901', N'Việt Nam', N'11 Đường X, Q5, TP.HCM', 'phamthid@gmail.com'),
('KH002', N'Hoàng Văn E', '0933444555', '098765432112', N'Việt Nam', N'22 Đường Y, Q6, TP.HCM', 'hoangvane@gmail.com'),
('KH003', N'Ngô Thị F', '0944556677', '076543219876', N'Việt Nam', N'33 Đường Z, Q7, TP.HCM', 'ngothif@gmail.com');

-- CĂN HỘ
INSERT INTO CAN_HO (MA_CH, MA_CN, TEN_CH, DIA_CHI, LOAI_CH, DIEN_TICH, GIA_THUE_DAI_HAN, GIA_THUE_NGAN_HAN)
VALUES
('CH001', 'CN001', N'Căn hộ A1', N'123 Đường A, Q1, TP.HCM', N'Còn trống', 50.0, 7000000, 8000000),
('CH002', 'CN001', N'Căn hộ A2', N'124 Đường A, Q1, TP.HCM', N'Đã thuê', 65.0, 9000000, 10000000),
('CH003', 'CN002', N'Căn hộ B1', N'456 Đường B, Q2, TP.HCM', N'Đã thuê', 40.0, 6000000, 7000000);

-- HỢP ĐỒNG
INSERT INTO HOP_DONG VALUES
('HD001', 'CH002', 'KH001', '2024-01-01', '2024-12-31', 10000000),
('HD002', 'CH003', 'KH002', '2024-02-01', '2024-08-01', 5000000),
('HD003', 'CH003', 'KH003', '2024-03-01', '2024-06-01', 3000000);

-- HÓA ĐƠN
INSERT INTO HOA_DON VALUES
('HD001001', 'HD001', '2024-02-01', 9000000),
('HD001002', 'HD001', '2024-03-01', 9000000),
('HD001003', 'HD001', '2024-04-01', 9000000),
('HD001004', 'HD001', '2024-05-01', 9000000),
('HD001005', 'HD001', '2024-06-01', 9000000),
('HD002001', 'HD002', '2024-03-01', 6000000),
('HD002002', 'HD002', '2024-04-01', 6000000),
('HD002003', 'HD002', '2024-05-01', 6000000),
('HD002004', 'HD002', '2024-06-01', 6000000),
('HD002005', 'HD002', '2024-07-01', 6000000),
('HD003001', 'HD003', '2024-03-01', 6000000),
('HD003002', 'HD003', '2024-04-01', 6000000),
('HD003003', 'HD003', '2024-05-01', 6000000);
GO

/*==============================================================*/
/* HÀM & THỦ TỤC                                                */
/*==============================================================*/
-- Thủ tục đăng nhập
DROP PROCEDURE IF EXISTS spCheckLogin;
GO

CREATE PROCEDURE spCheckLogin
    @email VARCHAR(100),
    @password VARCHAR(250)
AS
BEGIN
    SELECT * FROM TAI_KHOAN WHERE Email = @email AND PASSWORDHASH = @password;
END;
GO